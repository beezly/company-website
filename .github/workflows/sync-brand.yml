name: Sync Brand Standards

on:
  # Manual trigger - run when you want to check for brand updates
  workflow_dispatch:
  
  # Optional: Run weekly to check for updates (commented out by default)
  # schedule:
  #   - cron: '0 9 * * 1'  # Every Monday at 9 AM UTC

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-brand:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout website repository
        uses: actions/checkout@v4
      
      - name: Checkout brand repository
        uses: actions/checkout@v4
        with:
          repository: beezly/company-branding
          path: brand-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
      
      - name: Check brand version
        id: check-version
        run: |
          # Get current brand version from config
          CURRENT_VERSION=$(grep -o '"version": "[^"]*"' src/config.ts | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' | head -1)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # Get latest brand version from brand repo
          LATEST_VERSION=$(jq -r '.metadata.version' brand-repo/brand-standards/brand.json)
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          
          echo "Current brand version: $CURRENT_VERSION"
          echo "Latest brand version: $LATEST_VERSION"
          
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "âœ¨ Brand update available: $CURRENT_VERSION â†’ $LATEST_VERSION"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "âœ… Brand is up to date"
          fi
      
      - name: Create sync script
        if: steps.check-version.outputs.needs_update == 'true'
        run: |
          cat > sync-brand.sh << 'SCRIPT_EOF'
          #!/bin/bash
          set -e
          
          BRAND_JSON="brand-repo/brand-standards/brand.json"
          LATEST_VERSION="$1"
          
          echo "Syncing to version $LATEST_VERSION..."
          
          # Extract company name
          COMPANY_NAME=$(jq -r '.metadata.companyName' "$BRAND_JSON")
          
          # Update src/config.ts
          sed -i "s/version: \"[^\"]*\"/version: \"$LATEST_VERSION\"/" src/config.ts
          sed -i "s/companyName: \"[^\"]*\"/companyName: \"$COMPANY_NAME\"/" src/config.ts
          sed -i "s/Brand Standards Version: [0-9.]\+/Brand Standards Version: $LATEST_VERSION/" src/config.ts
          sed -i "s/Last Synced: [0-9-]\+/Last Synced: $(date +%Y-%m-%d)/" src/config.ts
          
          # Function to update brand-colors.ts
          update_color() {
            local color_key=$1
            local var_prefix=$2
            
            local name=$(jq -r ".colors.$color_key.name" "$BRAND_JSON")
            local hex=$(jq -r ".colors.$color_key.hex" "$BRAND_JSON")
            local r=$(jq -r ".colors.$color_key.rgb[0]" "$BRAND_JSON")
            local g=$(jq -r ".colors.$color_key.rgb[1]" "$BRAND_JSON")
            local b=$(jq -r ".colors.$color_key.rgb[2]" "$BRAND_JSON")
            local usage=$(jq -r ".colors.$color_key.usage" "$BRAND_JSON")
            
            sed -i "s/${var_prefix}_NAME/$name/" src/brand-colors.ts
            sed -i "s/${var_prefix}_HEX/$hex/" src/brand-colors.ts
            sed -i "s/${var_prefix}_R/$r/" src/brand-colors.ts
            sed -i "s/${var_prefix}_G/$g/" src/brand-colors.ts
            sed -i "s/${var_prefix}_B/$b/" src/brand-colors.ts
            sed -i "s/${var_prefix}_USAGE/$usage/" src/brand-colors.ts
          }
          
          # Create brand-colors.ts template
          cp src/brand-colors.ts src/brand-colors.ts.bak
          
          cat > src/brand-colors.ts << 'EOF'
/**
 * Brand Colors
 * 
 * Synchronized with Project Rhubarb brand standards
 * Source: https://github.com/beezly/company-branding
 * Brand Version: BRAND_VERSION_PLACEHOLDER
 * 
 * DO NOT modify these values directly. All brand colors should be updated
 * in the company-branding repository and synced here.
 */

export const brandColors = {
  primary: {
    name: "PRIMARY_NAME",
    hex: "PRIMARY_HEX",
    rgb: [PRIMARY_R, PRIMARY_G, PRIMARY_B] as const,
    usage: "PRIMARY_USAGE"
  },
  secondary: {
    name: "SECONDARY_NAME",
    hex: "SECONDARY_HEX",
    rgb: [SECONDARY_R, SECONDARY_G, SECONDARY_B] as const,
    usage: "SECONDARY_USAGE"
  },
  neutralDark: {
    name: "NEUTRAL_DARK_NAME",
    hex: "NEUTRAL_DARK_HEX",
    rgb: [NEUTRAL_DARK_R, NEUTRAL_DARK_G, NEUTRAL_DARK_B] as const,
    usage: "NEUTRAL_DARK_USAGE"
  },
  neutralMedium: {
    name: "NEUTRAL_MEDIUM_NAME",
    hex: "NEUTRAL_MEDIUM_HEX",
    rgb: [NEUTRAL_MEDIUM_R, NEUTRAL_MEDIUM_G, NEUTRAL_MEDIUM_B] as const,
    usage: "NEUTRAL_MEDIUM_USAGE"
  },
  neutralLight: {
    name: "NEUTRAL_LIGHT_NAME",
    hex: "NEUTRAL_LIGHT_HEX",
    rgb: [NEUTRAL_LIGHT_R, NEUTRAL_LIGHT_G, NEUTRAL_LIGHT_B] as const,
    usage: "NEUTRAL_LIGHT_USAGE"
  },
  success: {
    name: "SUCCESS_NAME",
    hex: "SUCCESS_HEX",
    rgb: [SUCCESS_R, SUCCESS_G, SUCCESS_B] as const,
    usage: "SUCCESS_USAGE"
  },
  warning: {
    name: "WARNING_NAME",
    hex: "WARNING_HEX",
    rgb: [WARNING_R, WARNING_G, WARNING_B] as const,
    usage: "WARNING_USAGE"
  },
  error: {
    name: "ERROR_NAME",
    hex: "ERROR_HEX",
    rgb: [ERROR_R, ERROR_G, ERROR_B] as const,
    usage: "ERROR_USAGE"
  },
  white: {
    name: "WHITE_NAME",
    hex: "WHITE_HEX",
    rgb: [WHITE_R, WHITE_G, WHITE_B] as const,
    usage: "WHITE_USAGE"
  }
} as const;

export type BrandColor = keyof typeof brandColors;
EOF
          
          # Update version placeholder
          sed -i "s/BRAND_VERSION_PLACEHOLDER/$LATEST_VERSION/" src/brand-colors.ts
          
          # Update all colors
          update_color "primary" "PRIMARY"
          update_color "secondary" "SECONDARY"
          update_color "neutral_dark" "NEUTRAL_DARK"
          update_color "neutral_medium" "NEUTRAL_MEDIUM"
          update_color "neutral_light" "NEUTRAL_LIGHT"
          update_color "success" "SUCCESS"
          update_color "warning" "WARNING"
          update_color "error" "ERROR"
          update_color "white" "WHITE"
          
          # Update CSS variables in global.css
          PRIMARY_HEX=$(jq -r '.colors.primary.hex' "$BRAND_JSON")
          SECONDARY_HEX=$(jq -r '.colors.secondary.hex' "$BRAND_JSON")
          NEUTRAL_DARK_HEX=$(jq -r '.colors.neutral_dark.hex' "$BRAND_JSON")
          NEUTRAL_MEDIUM_HEX=$(jq -r '.colors.neutral_medium.hex' "$BRAND_JSON")
          NEUTRAL_LIGHT_HEX=$(jq -r '.colors.neutral_light.hex' "$BRAND_JSON")
          SUCCESS_HEX=$(jq -r '.colors.success.hex' "$BRAND_JSON")
          WARNING_HEX=$(jq -r '.colors.warning.hex' "$BRAND_JSON")
          ERROR_HEX=$(jq -r '.colors.error.hex' "$BRAND_JSON")
          WHITE_HEX=$(jq -r '.colors.white.hex' "$BRAND_JSON")
          
          sed -i "s/--color-brand-primary: #[0-9A-Fa-f]\{6\}/--color-brand-primary: $PRIMARY_HEX/" src/styles/global.css
          sed -i "s/--color-brand-secondary: #[0-9A-Fa-f]\{6\}/--color-brand-secondary: $SECONDARY_HEX/" src/styles/global.css
          sed -i "s/--color-neutral-dark: #[0-9A-Fa-f]\{6\}/--color-neutral-dark: $NEUTRAL_DARK_HEX/" src/styles/global.css
          sed -i "s/--color-neutral-medium: #[0-9A-Fa-f]\{6\}/--color-neutral-medium: $NEUTRAL_MEDIUM_HEX/" src/styles/global.css
          sed -i "s/--color-neutral-light: #[0-9A-Fa-f]\{6\}/--color-neutral-light: $NEUTRAL_LIGHT_HEX/" src/styles/global.css
          sed -i "s/--color-success: #[0-9A-Fa-f]\{6\}/--color-success: $SUCCESS_HEX/" src/styles/global.css
          sed -i "s/--color-warning: #[0-9A-Fa-f]\{6\}/--color-warning: $WARNING_HEX/" src/styles/global.css
          sed -i "s/--color-error: #[0-9A-Fa-f]\{6\}/--color-error: $ERROR_HEX/" src/styles/global.css
          sed -i "s/--color-white: #[0-9A-Fa-f]\{6\}/--color-white: $WHITE_HEX/" src/styles/global.css
          
          sed -i "s/Version: [0-9.]\+/Version: $LATEST_VERSION/" src/styles/global.css
          sed -i "s/Last Synced: [0-9-]\+/Last Synced: $(date +%Y-%m-%d)/" src/styles/global.css
          
          # Update BRANDING.md
          sed -i "s/\*\*Current Version\*\*: [0-9.]\+/**Current Version**: $LATEST_VERSION/" BRANDING.md
          sed -i "s/\*\*Last Synced\*\*: [0-9-]\+/**Last Synced**: $(date +%Y-%m-%d)/" BRANDING.md
          
          echo "âœ… Brand standards synced to version $LATEST_VERSION"
          SCRIPT_EOF
          
          chmod +x sync-brand.sh
      
      - name: Run sync script
        if: steps.check-version.outputs.needs_update == 'true'
        run: |
          ./sync-brand.sh "${{ steps.check-version.outputs.latest_version }}"
      
      - name: Create Pull Request
        if: steps.check-version.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Sync brand standards to v${{ steps.check-version.outputs.latest_version }}
            
            - Update brand colors from company-branding repository
            - Update CSS variables with latest brand colors
            - Update configuration with new brand version
            - Sync from: https://github.com/beezly/company-branding
          branch: brand-sync-${{ steps.check-version.outputs.latest_version }}
          delete-branch: true
          title: "ðŸŽ¨ Sync brand standards to v${{ steps.check-version.outputs.latest_version }}"
          body: |
            ## Brand Standards Update
            
            This PR syncs the website with the latest brand standards from the [company-branding repository](https://github.com/beezly/company-branding).
            
            **Version Update**: `${{ steps.check-version.outputs.current_version }}` â†’ `${{ steps.check-version.outputs.latest_version }}`
            
            ### Changes
            - âœ… Updated brand colors in `src/brand-colors.ts`
            - âœ… Updated CSS variables in `src/styles/global.css`
            - âœ… Updated configuration in `src/config.ts`
            - âœ… Updated documentation in `BRANDING.md`
            
            ### Review Checklist
            - [ ] Review color changes
            - [ ] Test build locally (`npm run build`)
            - [ ] Preview site (`npm run preview`)
            - [ ] Verify brand consistency
            
            ### Next Steps
            1. Review the changes
            2. Test locally if needed
            3. Merge this PR
            4. The site will automatically deploy with the new branding
            
            ---
            ðŸ¤– This PR was automatically created by the brand sync workflow.
          labels: |
            branding
            automated
      
      - name: Summary
        run: |
          if [ "${{ steps.check-version.outputs.needs_update }}" == "true" ]; then
            echo "âœ¨ Brand update PR created: v${{ steps.check-version.outputs.current_version }} â†’ v${{ steps.check-version.outputs.latest_version }}"
          else
            echo "âœ… Brand is already up to date (v${{ steps.check-version.outputs.current_version }})"
          fi
