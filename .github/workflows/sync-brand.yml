name: Sync Brand Standards

# Manual trigger - run when you want to check for brand updates
on: workflow_dispatch

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-brand:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout website repository
        uses: actions/checkout@v4
      
      - name: Checkout brand repository
        uses: actions/checkout@v4
        with:
          repository: beezly/company-branding
          path: brand-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Check brand version
        id: check-version
        run: |
          # Install jq
          sudo apt-get update && sudo apt-get install -y jq
          
          # Get current brand version from config
          CURRENT_VERSION=$(grep -o '"version": "[^"]*"' src/config.ts | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' | head -1)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # Get latest brand version from brand repo
          LATEST_VERSION=$(jq -r '.metadata.version' brand-repo/brand-standards/brand.json)
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          
          echo "Current brand version: $CURRENT_VERSION"
          echo "Latest brand version: $LATEST_VERSION"
          
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "âœ¨ Brand update available: $CURRENT_VERSION â†’ $LATEST_VERSION"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "âœ… Brand is up to date"
          fi
      
      - name: Sync brand standards
        if: steps.check-version.outputs.needs_update == 'true'
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import re
          from datetime import date
          
          # Load brand JSON
          with open('brand-repo/brand-standards/brand.json', 'r') as f:
              brand = json.load(f)
          
          version = "${{ steps.check-version.outputs.latest_version }}"
          today = date.today().strftime('%Y-%m-%d')
          company_name = brand['metadata']['companyName']
          
          # Update src/config.ts
          with open('src/config.ts', 'r') as f:
              config = f.read()
          
          config = re.sub(r'version: "[^"]*"', f'version: "{version}"', config)
          config = re.sub(r'companyName: "[^"]*"', f'companyName: "{company_name}"', config)
          config = re.sub(r'Brand Standards Version: [0-9.]+', f'Brand Standards Version: {version}', config)
          config = re.sub(r'Last Synced: [0-9-]+', f'Last Synced: {today}', config)
          
          with open('src/config.ts', 'w') as f:
              f.write(config)
          
          # Generate brand-colors.ts
          colors_template = '''/**
 * Brand Colors
 * 
 * Synchronized with Project Rhubarb brand standards
 * Source: https://github.com/beezly/company-branding
 * Brand Version: {version}
 * 
 * DO NOT modify these values directly. All brand colors should be updated
 * in the company-branding repository and synced here.
 */

export const brandColors = {{
  primary: {{
    name: "{primary_name}",
    hex: "{primary_hex}",
    rgb: [{primary_r}, {primary_g}, {primary_b}] as const,
    usage: "{primary_usage}"
  }},
  secondary: {{
    name: "{secondary_name}",
    hex: "{secondary_hex}",
    rgb: [{secondary_r}, {secondary_g}, {secondary_b}] as const,
    usage: "{secondary_usage}"
  }},
  neutralDark: {{
    name: "{neutral_dark_name}",
    hex: "{neutral_dark_hex}",
    rgb: [{neutral_dark_r}, {neutral_dark_g}, {neutral_dark_b}] as const,
    usage: "{neutral_dark_usage}"
  }},
  neutralMedium: {{
    name: "{neutral_medium_name}",
    hex: "{neutral_medium_hex}",
    rgb: [{neutral_medium_r}, {neutral_medium_g}, {neutral_medium_b}] as const,
    usage: "{neutral_medium_usage}"
  }},
  neutralLight: {{
    name: "{neutral_light_name}",
    hex: "{neutral_light_hex}",
    rgb: [{neutral_light_r}, {neutral_light_g}, {neutral_light_b}] as const,
    usage: "{neutral_light_usage}"
  }},
  success: {{
    name: "{success_name}",
    hex: "{success_hex}",
    rgb: [{success_r}, {success_g}, {success_b}] as const,
    usage: "{success_usage}"
  }},
  warning: {{
    name: "{warning_name}",
    hex: "{warning_hex}",
    rgb: [{warning_r}, {warning_g}, {warning_b}] as const,
    usage: "{warning_usage}"
  }},
  error: {{
    name: "{error_name}",
    hex: "{error_hex}",
    rgb: [{error_r}, {error_g}, {error_b}] as const,
    usage: "{error_usage}"
  }},
  white: {{
    name: "{white_name}",
    hex: "{white_hex}",
    rgb: [{white_r}, {white_g}, {white_b}] as const,
    usage: "{white_usage}"
  }}
}} as const;

export type BrandColor = keyof typeof brandColors;
'''
          
          # Fill in color values
          colors = brand['colors']
          colors_content = colors_template.format(
              version=version,
              primary_name=colors['primary']['name'],
              primary_hex=colors['primary']['hex'],
              primary_r=colors['primary']['rgb'][0],
              primary_g=colors['primary']['rgb'][1],
              primary_b=colors['primary']['rgb'][2],
              primary_usage=colors['primary']['usage'],
              secondary_name=colors['secondary']['name'],
              secondary_hex=colors['secondary']['hex'],
              secondary_r=colors['secondary']['rgb'][0],
              secondary_g=colors['secondary']['rgb'][1],
              secondary_b=colors['secondary']['rgb'][2],
              secondary_usage=colors['secondary']['usage'],
              neutral_dark_name=colors['neutral_dark']['name'],
              neutral_dark_hex=colors['neutral_dark']['hex'],
              neutral_dark_r=colors['neutral_dark']['rgb'][0],
              neutral_dark_g=colors['neutral_dark']['rgb'][1],
              neutral_dark_b=colors['neutral_dark']['rgb'][2],
              neutral_dark_usage=colors['neutral_dark']['usage'],
              neutral_medium_name=colors['neutral_medium']['name'],
              neutral_medium_hex=colors['neutral_medium']['hex'],
              neutral_medium_r=colors['neutral_medium']['rgb'][0],
              neutral_medium_g=colors['neutral_medium']['rgb'][1],
              neutral_medium_b=colors['neutral_medium']['rgb'][2],
              neutral_medium_usage=colors['neutral_medium']['usage'],
              neutral_light_name=colors['neutral_light']['name'],
              neutral_light_hex=colors['neutral_light']['hex'],
              neutral_light_r=colors['neutral_light']['rgb'][0],
              neutral_light_g=colors['neutral_light']['rgb'][1],
              neutral_light_b=colors['neutral_light']['rgb'][2],
              neutral_light_usage=colors['neutral_light']['usage'],
              success_name=colors['success']['name'],
              success_hex=colors['success']['hex'],
              success_r=colors['success']['rgb'][0],
              success_g=colors['success']['rgb'][1],
              success_b=colors['success']['rgb'][2],
              success_usage=colors['success']['usage'],
              warning_name=colors['warning']['name'],
              warning_hex=colors['warning']['hex'],
              warning_r=colors['warning']['rgb'][0],
              warning_g=colors['warning']['rgb'][1],
              warning_b=colors['warning']['rgb'][2],
              warning_usage=colors['warning']['usage'],
              error_name=colors['error']['name'],
              error_hex=colors['error']['hex'],
              error_r=colors['error']['rgb'][0],
              error_g=colors['error']['rgb'][1],
              error_b=colors['error']['rgb'][2],
              error_usage=colors['error']['usage'],
              white_name=colors['white']['name'],
              white_hex=colors['white']['hex'],
              white_r=colors['white']['rgb'][0],
              white_g=colors['white']['rgb'][1],
              white_b=colors['white']['rgb'][2],
              white_usage=colors['white']['usage']
          )
          
          with open('src/brand-colors.ts', 'w') as f:
              f.write(colors_content)
          
          # Update CSS variables in global.css
          with open('src/styles/global.css', 'r') as f:
              css = f.read()
          
          css = re.sub(r'--color-brand-primary: #[0-9A-Fa-f]{6}', f'--color-brand-primary: {colors["primary"]["hex"]}', css)
          css = re.sub(r'--color-brand-secondary: #[0-9A-Fa-f]{6}', f'--color-brand-secondary: {colors["secondary"]["hex"]}', css)
          css = re.sub(r'--color-neutral-dark: #[0-9A-Fa-f]{6}', f'--color-neutral-dark: {colors["neutral_dark"]["hex"]}', css)
          css = re.sub(r'--color-neutral-medium: #[0-9A-Fa-f]{6}', f'--color-neutral-medium: {colors["neutral_medium"]["hex"]}', css)
          css = re.sub(r'--color-neutral-light: #[0-9A-Fa-f]{6}', f'--color-neutral-light: {colors["neutral_light"]["hex"]}', css)
          css = re.sub(r'--color-success: #[0-9A-Fa-f]{6}', f'--color-success: {colors["success"]["hex"]}', css)
          css = re.sub(r'--color-warning: #[0-9A-Fa-f]{6}', f'--color-warning: {colors["warning"]["hex"]}', css)
          css = re.sub(r'--color-error: #[0-9A-Fa-f]{6}', f'--color-error: {colors["error"]["hex"]}', css)
          css = re.sub(r'--color-white: #[0-9A-Fa-f]{6}', f'--color-white: {colors["white"]["hex"]}', css)
          css = re.sub(r'Version: [0-9.]+', f'Version: {version}', css)
          css = re.sub(r'Last Synced: [0-9-]+', f'Last Synced: {today}', css)
          
          with open('src/styles/global.css', 'w') as f:
              f.write(css)
          
          # Update BRANDING.md
          with open('BRANDING.md', 'r') as f:
              branding = f.read()
          
          branding = re.sub(r'\*\*Current Version\*\*: [0-9.]+', f'**Current Version**: {version}', branding)
          branding = re.sub(r'\*\*Last Synced\*\*: [0-9-]+', f'**Last Synced**: {today}', branding)
          
          with open('BRANDING.md', 'w') as f:
              f.write(branding)
          
          print(f"âœ… Brand standards synced to version {version}")
          PYTHON_SCRIPT
      
      - name: Create Pull Request
        if: steps.check-version.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Sync brand standards to v${{ steps.check-version.outputs.latest_version }}
            
            - Update brand colors from company-branding repository
            - Update CSS variables with latest brand colors
            - Update configuration with new brand version
            - Sync from: https://github.com/beezly/company-branding
          branch: brand-sync-${{ steps.check-version.outputs.latest_version }}
          delete-branch: true
          title: "ðŸŽ¨ Sync brand standards to v${{ steps.check-version.outputs.latest_version }}"
          body: |
            ## Brand Standards Update
            
            This PR syncs the website with the latest brand standards from the [company-branding repository](https://github.com/beezly/company-branding).
            
            **Version Update**: `${{ steps.check-version.outputs.current_version }}` â†’ `${{ steps.check-version.outputs.latest_version }}`
            
            ### Changes
            - âœ… Updated brand colors in `src/brand-colors.ts`
            - âœ… Updated CSS variables in `src/styles/global.css`
            - âœ… Updated configuration in `src/config.ts`
            - âœ… Updated documentation in `BRANDING.md`
            
            ### Review Checklist
            - [ ] Review color changes
            - [ ] Test build locally (`npm run build`)
            - [ ] Preview site (`npm run preview`)
            - [ ] Verify brand consistency
            
            ### Next Steps
            1. Review the changes
            2. Test locally if needed
            3. Merge this PR
            4. The site will automatically deploy with the new branding
            
            ---
            ðŸ¤– This PR was automatically created by the brand sync workflow.
          labels: |
            branding
            automated
      
      - name: Summary
        run: |
          if [ "${{ steps.check-version.outputs.needs_update }}" == "true" ]; then
            echo "âœ¨ Brand update PR created: v${{ steps.check-version.outputs.current_version }} â†’ v${{ steps.check-version.outputs.latest_version }}"
          else
            echo "âœ… Brand is already up to date (v${{ steps.check-version.outputs.current_version }})"
          fi
