name: Sync Brand Standards

# Manual trigger - run when you want to check for brand updates
on: workflow_dispatch

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-brand:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout website repository
        uses: actions/checkout@v4
      
      - name: Checkout brand repository
        uses: actions/checkout@v4
        with:
          repository: beezly/company-branding
          path: brand-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Check brand version
        id: check-version
        run: |
          # Install jq
          sudo apt-get update && sudo apt-get install -y jq
          
          # Get current brand version from config
          CURRENT_VERSION=$(grep -o '"version": "[^"]*"' src/config.ts | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' | head -1)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # Get latest brand version from brand repo
          LATEST_VERSION=$(jq -r '.metadata.version' brand-repo/brand-standards/brand.json)
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          
          echo "Current brand version: $CURRENT_VERSION"
          echo "Latest brand version: $LATEST_VERSION"
          
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "âœ¨ Brand update available: $CURRENT_VERSION â†’ $LATEST_VERSION"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "âœ… Brand is up to date"
          fi
      
      - name: Sync brand standards
        if: steps.check-version.outputs.needs_update == 'true'
        run: |
          chmod +x .github/scripts/sync-brand.py
          python3 .github/scripts/sync-brand.py "${{ steps.check-version.outputs.latest_version }}"
      
      - name: Create Pull Request
        if: steps.check-version.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Sync brand standards to v${{ steps.check-version.outputs.latest_version }}
            
            - Update brand colors from company-branding repository
            - Update CSS variables with latest brand colors
            - Update configuration with new brand version
            - Sync from: https://github.com/beezly/company-branding
          branch: brand-sync-${{ steps.check-version.outputs.latest_version }}
          delete-branch: true
          title: "ðŸŽ¨ Sync brand standards to v${{ steps.check-version.outputs.latest_version }}"
          body: |
            ## Brand Standards Update
            
            This PR syncs the website with the latest brand standards from the [company-branding repository](https://github.com/beezly/company-branding).
            
            **Version Update**: `${{ steps.check-version.outputs.current_version }}` â†’ `${{ steps.check-version.outputs.latest_version }}`
            
            ### Changes
            - âœ… Updated brand colors in `src/brand-colors.ts`
            - âœ… Updated CSS variables in `src/styles/global.css`
            - âœ… Updated configuration in `src/config.ts`
            - âœ… Updated documentation in `BRANDING.md`
            
            ### Review Checklist
            - [ ] Review color changes
            - [ ] Test build locally (`npm run build`)
            - [ ] Preview site (`npm run preview`)
            - [ ] Verify brand consistency
            
            ### Next Steps
            1. Review the changes
            2. Test locally if needed
            3. Merge this PR
            4. The site will automatically deploy with the new branding
            
            ---
            ðŸ¤– This PR was automatically created by the brand sync workflow.
          labels: |
            branding
            automated
      
      - name: Summary
        run: |
          if [ "${{ steps.check-version.outputs.needs_update }}" == "true" ]; then
            echo "âœ¨ Brand update PR created: v${{ steps.check-version.outputs.current_version }} â†’ v${{ steps.check-version.outputs.latest_version }}"
          else
            echo "âœ… Brand is already up to date (v${{ steps.check-version.outputs.current_version }})"
          fi
